package flows

import com.greenbird.metercloud.integration.flow.spec.FlowExchangePattern
import com.greenbird.metercloud.integration.flow.spec.dsl.FlowSpecConfig
import com.greenbird.metercloud.integration.flow.spec.dsl.HttpMethod
import com.greenbird.metercloud.integration.flow.spec.dsl.flowConfig
import java.net.URL
import java.nio.charset.StandardCharsets

object EntsoeFlow {
    val ownerID = "gridos"
    lateinit var outputProcessor: FlowSpecConfig.Builder.() -> Unit
    var startDate: String = "202510312200"
    var endDate: String = "202511032200"

    fun getFlowSpec(): FlowSpecConfig {
        return flowConfig {
            id = "entsoe-congestion-flow-raw"
            ownerId = ownerID
            exchangePattern = FlowExchangePattern.RequestResponse

            restApi {
                id = "entsoe-flow-api"
            }

            restRequest {
                id = "entsoe-flow-request-data"
                defaultMethod = HttpMethod.GET
                address = URL(getUrl())
            }

            // NO MAP - just save raw XML response
            outputProcessor()
        }
    }

    private fun getUrl(): String {
        val token = loadToken()
        val baseURL = "https://web-api.tp.entsoe.eu/api"
        val parameters = arrayOf(
            "documentType=A25",
            "businessType=B10",
            "contract_MarketAgreement.Type=A01",
            "out_Domain=10Y1001A1001A82H",
            "in_Domain=10Y1001A1001A82H",
            "periodStart=$startDate",
            "periodEnd=$endDate",
            "securityToken=${token}"
        )

        val queryUrl = parameters.joinToString("&")
        return "$baseURL?$queryUrl"
    }

    private fun loadToken(): String {
        val env = System.getenv("ENTSOE_TOKEN")
        if (!env.isNullOrBlank()) return env.trim()

        val res = Thread.currentThread().contextClassLoader
            .getResourceAsStream("deployment/gridos/presales/secrets/token.txt")
        if (res != null) {
            val text = res.bufferedReader(StandardCharsets.UTF_8).use { it.readText() }.trim()
            if (text.isNotBlank()) return text
        }

        throw IllegalStateException(
            "ENTSOE token not found. Put token in src/main/resources/deployment/gridos/presales/secrets/token.txt or set ENTSOE_TOKEN env var."
        )
    }
}
